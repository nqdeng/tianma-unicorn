元数据
------------------------------

独角兽除了能够处理通常的静态资源文件外，还能够处理带有*元数据*（meta，描述数据的数据）的文件。通常的文件只包含文件自身的数据，示意如下：

	+--------+
	|  DATA  |
	+--------+

而独角兽允许文件在头部包含一段额外的数据，用于保存与文件相关的元数据：

	+--------+
	|  META  |
	+--------+
	|  DATA  |
	+--------+

元数据类似于一种注释，描述了关于文件的一些额外信息，例如文件类型，或是文件的最后修改日期。

### 数据格式

独角兽支持的元数据使用*JSON*格式，按照以下二进制方式保存在文件头部：

	+-------+-----+-----+------+------+
	| MAGIC | VER | LEN | JSON | TAIL |
	+-------+-----+-----+------+------+

+ MAGIC

	8字节，内容固定为`2F 2A 21 6D 65 74 61 20`，按`utf8`编码转换为字符串后内容为`/*!meta `，用于判断一个文件是否带有元数据。

+ VER

	4字节，保留字段，用于在将来标识数据格式的版本。

+ LEN

	4字节，按`utf8`编码转换为字符串后内容为*JSON*二进制数据的十六进制字节长度。由于四位十六进制数字最大值为`FFFF`，因此*JSON*二进制数据的最大长度为65535字节。

+ JSON

	JSON字符串按`utf8`编码转换为二进制数据后的结果。

+ TAIL

	2字节，内容固定为`2A 2F`，按`utf8`编码转换为字符串后内容为`*/`。

以下是一个带有元数据的文件的示例：

	        MAGIC                VER         LEN
	-----------------------  ----------- -----------
	2F 2A 21 6D 65 74 61 20  20 20 20 20 20 20 20 32  | /*!meta         2
	7B 7D 2A 2F 0A 76 61 72  20 61 3B                 | {}*/.var a;
	----- -----
	 JSON  TAIL

如果按`utf8`将以上文件转换为字符串后，内容如下：

	/*!meta        2{}*/
	var a;

可以看到，以上文件虽然带有元数据，但由于JSON是空的，所以并不包含任何实质内容。

### 数据字段

独角兽使用元数据中的以下字段实现一些功能：

#### mime

元数据中可以通过`mime`字段来指定文件的MIME类型，这样独角兽就不再根据文件扩展名来判断文件的MIME类型。

	{ "mime": "application/javascript" }

#### mtime

元数据中可以通过`mtime`字段，以`GMT`格式来指定文件的最后修改日期，这样独角兽就不再读取文件原本的最后修改日期。

	{ "mtime": "Mon, 23 May 2014 08:46:54 GMT" }

#### requires

元数据中可以通过`requires`字段来申明文件依赖的其它文件的绝对路径，这样独角兽就会针对该文件启用*服务端依赖管理*。

	{ "requires": [ "b.js" ] }

### 数据生成

元数据虽然转换为字符串后是可读的，但很明显，元数据不是开发者手写出来的。如果希望利用上独角兽的元数据相关功能，就需要借助*构建工具*来对发布上线的静态文件做编译。

例如，开发者可以在`a.css`当中按照以下方式申明依赖：

	@import 'b.css';
	p {color:red;}

在`a.css`发布上线前，开发者可以使用*构建工具*将`a.css`中的依赖申明语句转换为独角兽支持的元数据，转换后的文件内容如下：

	/*!meta       16{"requires":["b.css"]}*/
	p {color:red;}

### 异常处理

如果请求的文件带有元数据，但是数据损，无法被正常解析，这种情况下独角兽会抛出异常。